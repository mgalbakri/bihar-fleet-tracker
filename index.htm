<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>BIHAR Fleet Tracker</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --border: #475569;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --amber: #f59e0b;
            --amber-light: #fbbf24;
            --teal: #14b8a6;
            --blue: #3b82f6;
            --red: #ef4444;
            --green: #22c55e;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --header-height: 64px;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        /* Header */
        .header {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: calc(var(--header-height) + var(--safe-top));
            padding-top: var(--safe-top);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-left: 16px;
            padding-right: 16px;
            z-index: 1000;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 42px; height: 42px;
            background: linear-gradient(135deg, var(--amber), #d97706);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }

        .logo-text h1 { font-size: 18px; font-weight: 700; }
        .logo-text p { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }

        .header-right { display: flex; align-items: center; gap: 16px; }

        .stats { display: none; gap: 24px; }
        .stat { text-align: center; }
        .stat-value { font-size: 20px; font-weight: 700; color: var(--amber-light); }
        .stat-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; }

        .live-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--bg-tertiary);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            color: var(--green);
            text-transform: uppercase;
        }

        .live-dot {
            width: 8px; height: 8px;
            background: var(--green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* Main Layout */
        .app {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding-top: calc(var(--header-height) + var(--safe-top));
        }

        /* Map */
        .map-wrapper {
            flex: 1;
            position: relative;
            min-height: 0;
        }

        #map {
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
        }

        /* Leaflet Overrides */
        .leaflet-container { background: #0f172a !important; font-family: 'Inter', sans-serif !important; }
        .leaflet-control-zoom { border: none !important; box-shadow: 0 2px 10px rgba(0,0,0,0.3) !important; }
        .leaflet-control-zoom a { 
            background: #1e293b !important; 
            color: #f8fafc !important; 
            border: 1px solid #475569 !important; 
            width: 36px !important; 
            height: 36px !important; 
            line-height: 36px !important; 
        }
        .leaflet-control-zoom a:hover { background: #334155 !important; }
        .leaflet-popup-content-wrapper { background: #1e293b !important; color: #f8fafc !important; border-radius: 12px !important; }
        .leaflet-popup-tip { background: #1e293b !important; }

        /* Loading */
        .map-loading {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 500;
            gap: 16px;
        }
        .map-loading.hidden { display: none; }
        .spinner {
            width: 40px; height: 40px;
            border: 3px solid var(--bg-tertiary);
            border-top-color: var(--amber);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .map-loading p { color: var(--text-secondary); font-size: 14px; }
        .map-loading .error { color: var(--red); }
        .map-loading button {
            margin-top: 10px;
            padding: 10px 20px;
            background: var(--amber);
            border: none;
            border-radius: 8px;
            color: #000;
            font-weight: 600;
            cursor: pointer;
        }

        /* Map Controls */
        .map-controls {
            position: absolute;
            top: 12px; right: 12px;
            z-index: 400;
        }

        .map-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 14px;
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }
        .map-btn:active { background: var(--bg-tertiary); }

        /* Legend */
        .legend {
            position: absolute;
            bottom: 12px; left: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 14px;
            z-index: 400;
            display: flex;
            gap: 12px;
        }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text-secondary); }
        .legend-dot { width: 10px; height: 10px; border-radius: 50%; }
        .legend-dot.tanker { background: var(--amber); }
        .legend-dot.lpg { background: var(--teal); }
        .legend-dot.chemical { background: var(--blue); }
        .legend-dot.crude { background: var(--red); }

        /* Markers */
        .marker {
            width: 32px; height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            border: 2px solid rgba(255,255,255,0.3);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .marker:hover { transform: scale(1.15); }
        .marker.selected { transform: scale(1.25); border-color: #fff; box-shadow: 0 0 20px rgba(245,158,11,0.6); }
        .marker.tanker { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .marker.lpg { background: linear-gradient(135deg, #14b8a6, #0d9488); }
        .marker.chemical { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .marker.crude { background: linear-gradient(135deg, #ef4444, #dc2626); }

        /* Panel */
        .panel-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 600;
        }
        .panel-overlay.visible { display: block; }

        .panel {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: var(--bg-secondary);
            border-radius: 20px 20px 0 0;
            z-index: 700;
            max-height: calc(80% - var(--safe-top));
            display: flex;
            flex-direction: column;
            transform: translateY(calc(100% - 70px));
            transition: transform 0.3s ease-out;
            padding-bottom: var(--safe-bottom);
        }
        .panel.open { transform: translateY(0); }

        .panel-handle { padding: 12px; display: flex; justify-content: center; cursor: pointer; }
        .panel-handle span { width: 40px; height: 5px; background: var(--bg-tertiary); border-radius: 3px; }

        .panel-header { padding: 0 16px 12px; border-bottom: 1px solid var(--border); }
        .panel-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .panel-title h2 { font-size: 16px; font-weight: 600; }
        .vessel-count { background: var(--bg-tertiary); padding: 4px 10px; border-radius: 12px; font-size: 12px; color: var(--text-secondary); }

        .search-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 16px;
            font-family: inherit;
            outline: none;
        }
        .search-input:focus { border-color: var(--amber); }
        .search-input::placeholder { color: var(--text-muted); }

        .filters { display: flex; gap: 8px; margin-top: 12px; overflow-x: auto; padding-bottom: 4px; }
        .filters::-webkit-scrollbar { display: none; }
        .filter-btn {
            flex-shrink: 0;
            padding: 8px 14px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
        }
        .filter-btn.active { background: var(--amber); border-color: var(--amber); color: #000; }

        /* Vessel List */
        .vessel-list { flex: 1; overflow-y: auto; padding: 12px; -webkit-overflow-scrolling: touch; }

        .vessel-card {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            cursor: pointer;
            position: relative;
            padding-left: 18px;
        }
        .vessel-card::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0;
            width: 4px;
            border-radius: 12px 0 0 12px;
        }
        .vessel-card.tanker::before { background: var(--amber); }
        .vessel-card.lpg::before { background: var(--teal); }
        .vessel-card.chemical::before { background: var(--blue); }
        .vessel-card.crude::before { background: var(--red); }
        .vessel-card:active { background: var(--bg-secondary); }
        .vessel-card.selected { border-color: var(--amber); background: var(--bg-secondary); }

        .vessel-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .vessel-name { font-size: 15px; font-weight: 600; }
        .vessel-imo { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
        .vessel-badge { font-size: 10px; font-weight: 600; padding: 4px 8px; border-radius: 4px; text-transform: uppercase; }
        .vessel-badge.tanker { background: rgba(245,158,11,0.15); color: var(--amber-light); }
        .vessel-badge.lpg { background: rgba(20,184,166,0.15); color: var(--teal); }
        .vessel-badge.chemical { background: rgba(59,130,246,0.15); color: var(--blue); }
        .vessel-badge.crude { background: rgba(239,68,68,0.15); color: var(--red); }
        .vessel-location { font-size: 13px; color: var(--text-secondary); }

        /* Detail Modal */
        .detail-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 800;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        .detail-overlay.visible { opacity: 1; visibility: visible; }

        .detail-modal {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: var(--bg-secondary);
            border-radius: 20px 20px 0 0;
            z-index: 900;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            padding-bottom: var(--safe-bottom);
        }
        .detail-modal.visible { transform: translateY(0); }

        .detail-handle { padding: 12px; display: flex; justify-content: center; }
        .detail-handle span { width: 40px; height: 5px; background: var(--bg-tertiary); border-radius: 3px; }

        .detail-header {
            padding: 0 20px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .detail-title { font-size: 22px; font-weight: 700; }
        .detail-imo { font-size: 14px; color: var(--amber); margin-top: 4px; }
        .detail-close {
            width: 36px; height: 36px;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .detail-body { padding: 20px; overflow-y: auto; flex: 1; }
        .detail-section { margin-bottom: 20px; }
        .detail-section:last-child { margin-bottom: 0; }
        .detail-section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }
        .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .detail-item { background: var(--bg-primary); border-radius: 10px; padding: 12px; }
        .detail-item.full { grid-column: span 2; }
        .detail-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; }
        .detail-value { font-size: 14px; font-weight: 500; }
        .detail-status { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; }
        .detail-status.active { background: rgba(34,197,94,0.15); color: var(--green); }
        .detail-status.maintenance { background: rgba(245,158,11,0.15); color: var(--amber); }
        .detail-status-dot { width: 6px; height: 6px; background: currentColor; border-radius: 50%; }
        .charter-box { background: var(--bg-primary); border-radius: 10px; padding: 14px; }
        .charter-company { font-size: 15px; font-weight: 600; margin-bottom: 12px; }
        .charter-dates { display: flex; gap: 20px; }
        .charter-date-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; }
        .charter-date-value { font-size: 13px; color: var(--text-secondary); margin-top: 2px; }
        .status-box { background: var(--bg-primary); border-radius: 10px; padding: 14px; font-size: 14px; line-height: 1.6; color: var(--text-secondary); }

        /* Desktop */
        @media (min-width: 768px) {
            .header { padding-left: 24px; padding-right: 24px; }
            .stats { display: flex; }
            .app { flex-direction: row; }
            .map-wrapper { flex: 1; order: 2; }
            .panel-overlay { display: none !important; }
            .panel {
                position: relative;
                order: 1;
                width: 380px;
                flex-shrink: 0;
                transform: none;
                border-radius: 0;
                max-height: none;
                border-right: 1px solid var(--border);
            }
            .panel-handle { display: none; }
            .panel-header { padding: 20px; }
            .vessel-list { padding: 16px; }
            .vessel-card:hover { background: var(--bg-secondary); border-color: var(--text-muted); }
            .map-btn { display: none; }
            .legend { flex-direction: column; gap: 8px; }
            .detail-overlay { display: none !important; }
            .detail-modal {
                position: absolute;
                top: 16px; right: 16px;
                bottom: auto; left: auto;
                width: 360px;
                max-height: calc(100% - 32px);
                border-radius: 16px;
                transform: translateX(400px);
                opacity: 0;
            }
            .detail-modal.visible { transform: translateX(0); opacity: 1; }
            .detail-handle { display: none; }
        }

        @media (min-width: 1024px) {
            .panel { width: 420px; }
        }
    </style>
    
    <!-- Leaflet CSS from CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
</head>
<body>
    <header class="header">
        <div class="logo">
            <div class="logo-icon">‚öì</div>
            <div class="logo-text">
                <h1>BIHAR Fleet</h1>
                <p>Real-Time Tracking</p>
            </div>
        </div>
        <div class="header-right">
            <div class="stats">
                <div class="stat"><div class="stat-value">23</div><div class="stat-label">Vessels</div></div>
                <div class="stat"><div class="stat-value">21</div><div class="stat-label">Active</div></div>
                <div class="stat"><div class="stat-value">2</div><div class="stat-label">Maintenance</div></div>
            </div>
            <div class="live-badge"><div class="live-dot"></div><span>Live</span></div>
        </div>
    </header>

    <div class="app">
        <div class="map-wrapper">
            <div id="map"></div>
            <div class="map-loading" id="mapLoading">
                <div class="spinner"></div>
                <p>Loading map...</p>
            </div>
            <div class="map-controls">
                <button class="map-btn" onclick="centerFleet()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg>
                    Center
                </button>
            </div>
            <div class="legend">
                <div class="legend-item"><div class="legend-dot tanker"></div>Tanker</div>
                <div class="legend-item"><div class="legend-dot lpg"></div>LPG</div>
                <div class="legend-item"><div class="legend-dot chemical"></div>Chemical</div>
                <div class="legend-item"><div class="legend-dot crude"></div>Crude</div>
            </div>
        </div>

        <div class="panel-overlay" id="panelOverlay" onclick="togglePanel()"></div>
        <div class="panel" id="panel">
            <div class="panel-handle" onclick="togglePanel()"><span></span></div>
            <div class="panel-header">
                <div class="panel-title">
                    <h2>Fleet Overview</h2>
                    <span class="vessel-count" id="vesselCount">23 Vessels</span>
                </div>
                <input type="text" class="search-input" id="searchInput" placeholder="Search vessel, IMO, location...">
                <div class="filters">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="tanker">Tankers</button>
                    <button class="filter-btn" data-filter="lpg">LPG</button>
                    <button class="filter-btn" data-filter="chemical">Chemical</button>
                    <button class="filter-btn" data-filter="crude">Crude</button>
                </div>
            </div>
            <div class="vessel-list" id="vesselList"></div>
        </div>

        <div class="detail-overlay" id="detailOverlay" onclick="closeDetail()"></div>
        <div class="detail-modal" id="detailModal">
            <div class="detail-handle"><span></span></div>
            <div class="detail-header">
                <div>
                    <div class="detail-title" id="detailTitle">Vessel Name</div>
                    <div class="detail-imo" id="detailImo">IMO: 0000000</div>
                </div>
                <button class="detail-close" onclick="closeDetail()">√ó</button>
            </div>
            <div class="detail-body" id="detailBody"></div>
        </div>
    </div>

    <script>
        // Fleet Data
        var vessels = [
            { id: 1, name: "Israa", imo: "9325960", type: "tanker", typeLabel: "Oil Tanker", dwt: "7,319 MT", built: 2011, charterer: "PETCO, Malaysia", delivered: "25/12/2022", redelivery: "24/06/2026", status: "Completed discharge at Prai, Malaysia. Sailing to Singapore.", location: "Prai, Malaysia", lat: 5.3841, lng: 100.3938, active: true },
            { id: 2, name: "Al Zarandi", imo: "9325958", type: "tanker", typeLabel: "Oil Tanker", dwt: "7,303 MT", built: 2010, charterer: "Bihar Bunkers", delivered: "29/02/2020", redelivery: "Yearly", status: "At Jeddah for bunkering.", location: "Jeddah, Saudi Arabia", lat: 21.5433, lng: 39.1728, active: true },
            { id: 3, name: "Galbot", imo: "9555084", type: "tanker", typeLabel: "Oil Tanker", dwt: "7,281 MT", built: 2010, charterer: "Sacor Bunkers", delivered: "24/10/2023", redelivery: "23/10/2026", status: "At Sines, Portugal for bunkering.", location: "Sines, Portugal", lat: 37.9500, lng: -8.8667, active: true },
            { id: 4, name: "Al Safa", imo: "9501643", type: "tanker", typeLabel: "Oil Tanker", dwt: "7,324 MT", built: 2009, charterer: "Amsol", delivered: "20/01/2020", redelivery: "18/01/2026", status: "At Durban for bunkering.", location: "Durban, South Africa", lat: -29.8587, lng: 31.0218, active: true },
            { id: 5, name: "Andes", imo: "9411719", type: "tanker", typeLabel: "Oil Tanker", dwt: "7,364 MT", built: 2007, charterer: "International Supply", delivered: "31/12/2019", redelivery: "Yearly", status: "At Fujairah for bunkering.", location: "Fujairah, UAE", lat: 25.1288, lng: 56.3264, active: true },
            { id: 6, name: "Miraj", imo: "9394741", type: "tanker", typeLabel: "Oil Tanker", dwt: "7,450 MT", built: 2007, charterer: "Waad Energy", delivered: "25/02/2024", redelivery: "Yearly", status: "At Jeddah for bunkering.", location: "Jeddah, Saudi Arabia", lat: 21.5169, lng: 39.1489, active: true },
            { id: 7, name: "Daisy", imo: "9516545", type: "tanker", typeLabel: "Oil Tanker", dwt: "7,280 MT", built: 2009, charterer: "International Supply", delivered: "14/11/2023", redelivery: "Yearly", status: "Pre dry dock repairs at Khor Fakkan.", location: "Khor Fakkan, UAE", lat: 25.3436, lng: 56.3475, active: false },
            { id: 8, name: "Lilac", imo: "9411721", type: "tanker", typeLabel: "Oil Tanker", dwt: "7,373 MT", built: 2009, charterer: "International Supply", delivered: "-", redelivery: "-", status: "At Fujairah (replacement for Daisy).", location: "Fujairah, UAE", lat: 25.1488, lng: 56.3464, active: true },
            { id: 9, name: "Al Barrah", imo: "9332030", type: "lpg", typeLabel: "LPG Carrier", dwt: "27,710 MT", built: 2007, charterer: "ENOC, UAE", delivered: "01/04/2024", redelivery: "31/03/2027", status: "At Jebel Ali, waiting to discharge.", location: "Jebel Ali, UAE", lat: 25.0066, lng: 55.0580, active: true },
            { id: 10, name: "Al Jabirah", imo: "9332042", type: "lpg", typeLabel: "LPG Carrier", dwt: "27,710 MT", built: 2007, charterer: "Indian Oil Corp", delivered: "15/11/2025", redelivery: "14/11/2026", status: "Sailing to Kandla with propane/butane.", location: "Arabian Sea", lat: 21.8243, lng: 65.4567, active: true },
            { id: 11, name: "Al Shaffiah", imo: "9358620", type: "chemical", typeLabel: "Chemical", dwt: "19,907 MT", built: 2006, charterer: "Aramco Trading", delivered: "30/04/2024", redelivery: "29/04/2026", status: "Sailing to Jubail.", location: "Indian Ocean", lat: 15.5432, lng: 68.2341, active: true },
            { id: 12, name: "Al Mahboobah", imo: "9340415", type: "chemical", typeLabel: "Chemical", dwt: "19,982 MT", built: 2006, charterer: "Aramco Trading", delivered: "02/05/2024", redelivery: "01/05/2026", status: "At Jubail, waiting to load.", location: "Jubail, Saudi Arabia", lat: 27.0046, lng: 49.6588, active: true },
            { id: 13, name: "Dianella", imo: "9901087", type: "chemical", typeLabel: "Product/Chemical", dwt: "49,803 MT", built: 2021, charterer: "PETCO", delivered: "21/01/2024", redelivery: "15/01/2026", status: "Discharging at Shenao, Taiwan.", location: "Shenao, Taiwan", lat: 25.1276, lng: 121.8167, active: true },
            { id: 14, name: "Liatris", imo: "9901099", type: "chemical", typeLabel: "Product/Chemical", dwt: "49,803 MT", built: 2021, charterer: "ISTC (Sabic)", delivered: "06/05/2023", redelivery: "05/05/2026", status: "Sailing to Singapore for bunkers.", location: "South China Sea", lat: 18.4523, lng: 114.3421, active: true },
            { id: 15, name: "Angelonia", imo: "9901051", type: "tanker", typeLabel: "Oil Tanker", dwt: "110,521 MT", built: 2021, charterer: "Aramco Trading", delivered: "13/01/2024", redelivery: "12/01/2027", status: "At Suez STS Area, discharging.", location: "Suez, Egypt", lat: 29.9668, lng: 32.5498, active: true },
            { id: 16, name: "Lunaria", imo: "9901063", type: "tanker", typeLabel: "Oil Tanker", dwt: "110,521 MT", built: 2021, charterer: "Aramco Trading", delivered: "25/01/2024", redelivery: "24/01/2027", status: "Sailing to Venice with gas oil.", location: "Mediterranean", lat: 38.4521, lng: 16.3456, active: true },
            { id: 17, name: "Bouvardia", imo: "9935595", type: "tanker", typeLabel: "Oil Tanker", dwt: "111,075 MT", built: 2022, charterer: "Aramco Trading", delivered: "19/03/2025", redelivery: "18/03/2028", status: "At Antwerp, loading VLSFO.", location: "Antwerp, Belgium", lat: 51.2194, lng: 4.4025, active: true },
            { id: 18, name: "Ixora", imo: "9940459", type: "tanker", typeLabel: "Oil Tanker", dwt: "111,006 MT", built: 2022, charterer: "Aramco Trading", delivered: "09/03/2025", redelivery: "08/03/2028", status: "Sailing to Tanjung Buras with HFO.", location: "South China Sea", lat: 7.4523, lng: 107.3421, active: true },
            { id: 19, name: "Al Habibah", imo: "9290294", type: "crude", typeLabel: "Crude/Product", dwt: "105,946 MT", built: 2004, charterer: "Utility Ops", delivered: "-", redelivery: "-", status: "Pre dry dock at Khor Fakkan.", location: "Khor Fakkan, UAE", lat: 25.3636, lng: 56.3675, active: false },
            { id: 20, name: "Al Mahfoza", imo: "9271365", type: "crude", typeLabel: "Crude/Product", dwt: "105,433 MT", built: 2003, charterer: "Utility Ops", delivered: "-", redelivery: "-", status: "Sailing to Fujairah.", location: "Gulf of Oman", lat: 24.5432, lng: 57.8765, active: true },
            { id: 21, name: "Daffodil", imo: "9239927", type: "crude", typeLabel: "Crude/Product", dwt: "105,357 MT", built: 2002, charterer: "Utility Ops", delivered: "-", redelivery: "-", status: "Discharging at Shoaiba.", location: "Shoaiba, Saudi Arabia", lat: 20.6894, lng: 39.5087, active: true },
            { id: 22, name: "Desert Rose", imo: "9239939", type: "crude", typeLabel: "Crude/Product", dwt: "105,328 MT", built: 2002, charterer: "Utility Ops", delivered: "-", redelivery: "-", status: "Off Yanbu, waiting to load.", location: "Yanbu, Saudi Arabia", lat: 24.0894, lng: 38.0634, active: true },
            { id: 23, name: "Encelia", imo: "9240172", type: "crude", typeLabel: "Crude/Product", dwt: "109,250 MT", built: 2003, charterer: "Utility Ops", delivered: "-", redelivery: "-", status: "Waiting to load utility cargo.", location: "Saudi Arabia", lat: 26.2345, lng: 50.1234, active: true }
        ];

        var map = null;
        var markers = {};
        var selectedId = null;
        var panelOpen = false;

        // Load Leaflet dynamically with fallbacks
        function loadLeaflet() {
            var cdns = [
                'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js',
                'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js',
                'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.js'
            ];
            
            tryLoadScript(cdns, 0);
        }

        function tryLoadScript(cdns, index) {
            if (index >= cdns.length) {
                showError();
                return;
            }

            var script = document.createElement('script');
            script.src = cdns[index];
            script.onload = function() {
                if (typeof L !== 'undefined') {
                    initApp();
                } else {
                    tryLoadScript(cdns, index + 1);
                }
            };
            script.onerror = function() {
                tryLoadScript(cdns, index + 1);
            };
            document.body.appendChild(script);
        }

        function showError() {
            document.getElementById('mapLoading').innerHTML = 
                '<p class="error">Could not load map library.</p>' +
                '<button onclick="location.reload()">Retry</button>';
        }

        function initApp() {
            initMap();
            renderList(vessels);
            setupEvents();
        }

        function initMap() {
            try {
                map = L.map('map', {
                    center: [22, 50],
                    zoom: 3,
                    zoomControl: true,
                    attributionControl: false
                });

                // Try multiple tile sources
                L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19
                }).addTo(map);

                vessels.forEach(function(v) {
                    var icon = L.divIcon({
                        html: '<div class="marker ' + v.type + '">' + (v.type === 'lpg' ? '‚õΩ' : 'üö¢') + '</div>',
                        className: '',
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    });

                    var marker = L.marker([v.lat, v.lng], { icon: icon }).addTo(map);
                    marker.on('click', function() { selectVessel(v.id); });
                    markers[v.id] = marker;
                });

                document.getElementById('mapLoading').classList.add('hidden');
                map.on('click', function() { if (selectedId) deselectVessel(); });

            } catch (e) {
                showError();
            }
        }

        function selectVessel(id) {
            if (selectedId) {
                var pv = vessels.find(function(v) { return v.id === selectedId; });
                if (pv && markers[selectedId]) {
                    markers[selectedId].setIcon(L.divIcon({
                        html: '<div class="marker ' + pv.type + '">' + (pv.type === 'lpg' ? '‚õΩ' : 'üö¢') + '</div>',
                        className: '', iconSize: [32, 32], iconAnchor: [16, 16]
                    }));
                }
                var pc = document.querySelector('.vessel-card.selected');
                if (pc) pc.classList.remove('selected');
            }

            selectedId = id;
            var v = vessels.find(function(x) { return x.id === id; });
            if (!v) return;

            markers[id].setIcon(L.divIcon({
                html: '<div class="marker ' + v.type + ' selected">' + (v.type === 'lpg' ? '‚õΩ' : 'üö¢') + '</div>',
                className: '', iconSize: [32, 32], iconAnchor: [16, 16]
            }));

            var card = document.querySelector('.vessel-card[data-id="' + id + '"]');
            if (card) { card.classList.add('selected'); card.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }

            map.setView([v.lat, v.lng], 5, { animate: true });
            showDetail(v);

            if (window.innerWidth < 768 && panelOpen) togglePanel();
        }

        function deselectVessel() {
            if (!selectedId) return;
            var v = vessels.find(function(x) { return x.id === selectedId; });
            if (v && markers[selectedId]) {
                markers[selectedId].setIcon(L.divIcon({
                    html: '<div class="marker ' + v.type + '">' + (v.type === 'lpg' ? '‚õΩ' : 'üö¢') + '</div>',
                    className: '', iconSize: [32, 32], iconAnchor: [16, 16]
                }));
            }
            var pc = document.querySelector('.vessel-card.selected');
            if (pc) pc.classList.remove('selected');
            selectedId = null;
            closeDetail();
        }

        function showDetail(v) {
            document.getElementById('detailTitle').textContent = v.name;
            document.getElementById('detailImo').textContent = 'IMO: ' + v.imo;
            var sc = v.active ? 'active' : 'maintenance';
            var st = v.active ? 'Active' : 'Maintenance';

            document.getElementById('detailBody').innerHTML = 
                '<div class="detail-section"><div class="detail-section-title">Vessel Information</div><div class="detail-grid">' +
                '<div class="detail-item"><div class="detail-label">Type</div><div class="detail-value">' + v.typeLabel + '</div></div>' +
                '<div class="detail-item"><div class="detail-label">Status</div><div class="detail-value"><span class="detail-status ' + sc + '"><span class="detail-status-dot"></span>' + st + '</span></div></div>' +
                '<div class="detail-item"><div class="detail-label">Deadweight</div><div class="detail-value">' + v.dwt + '</div></div>' +
                '<div class="detail-item"><div class="detail-label">Built</div><div class="detail-value">' + v.built + '</div></div>' +
                '<div class="detail-item full"><div class="detail-label">Location</div><div class="detail-value">' + v.location + '</div></div>' +
                '<div class="detail-item"><div class="detail-label">Lat</div><div class="detail-value">' + v.lat.toFixed(4) + '¬∞</div></div>' +
                '<div class="detail-item"><div class="detail-label">Lng</div><div class="detail-value">' + v.lng.toFixed(4) + '¬∞</div></div>' +
                '</div></div>' +
                '<div class="detail-section"><div class="detail-section-title">Charter</div><div class="charter-box">' +
                '<div class="charter-company">' + v.charterer + '</div>' +
                '<div class="charter-dates"><div><div class="charter-date-label">Delivered</div><div class="charter-date-value">' + v.delivered + '</div></div>' +
                '<div><div class="charter-date-label">Redelivery</div><div class="charter-date-value">' + v.redelivery + '</div></div></div></div></div>' +
                '<div class="detail-section"><div class="detail-section-title">Status</div><div class="status-box">' + v.status + '</div></div>';

            document.getElementById('detailModal').classList.add('visible');
            document.getElementById('detailOverlay').classList.add('visible');
        }

        function closeDetail() {
            document.getElementById('detailModal').classList.remove('visible');
            document.getElementById('detailOverlay').classList.remove('visible');
        }

        function togglePanel() {
            panelOpen = !panelOpen;
            document.getElementById('panel').classList.toggle('open', panelOpen);
            document.getElementById('panelOverlay').classList.toggle('visible', panelOpen);
        }

        function centerFleet() {
            if (!map) return;
            var bounds = L.latLngBounds(vessels.map(function(v) { return [v.lat, v.lng]; }));
            map.fitBounds(bounds, { padding: [30, 30] });
        }

        function renderList(list) {
            var html = list.map(function(v) {
                return '<div class="vessel-card ' + v.type + (v.id === selectedId ? ' selected' : '') + '" data-id="' + v.id + '" onclick="selectVessel(' + v.id + ')">' +
                    '<div class="vessel-header"><div><div class="vessel-name">' + v.name + '</div><div class="vessel-imo">IMO: ' + v.imo + '</div></div>' +
                    '<span class="vessel-badge ' + v.type + '">' + v.typeLabel + '</span></div>' +
                    '<div class="vessel-location">üìç ' + v.location + '</div></div>';
            }).join('');
            document.getElementById('vesselList').innerHTML = html;
            document.getElementById('vesselCount').textContent = list.length + ' Vessels';
        }

        function setupEvents() {
            document.getElementById('searchInput').addEventListener('input', function(e) {
                var q = e.target.value.toLowerCase();
                var filtered = vessels.filter(function(v) {
                    return v.name.toLowerCase().indexOf(q) > -1 || v.imo.indexOf(q) > -1 || v.location.toLowerCase().indexOf(q) > -1;
                });
                renderList(filtered);
            });

            var filterBtns = document.querySelectorAll('.filter-btn');
            filterBtns.forEach(function(btn) {
                btn.addEventListener('click', function() {
                    filterBtns.forEach(function(b) { b.classList.remove('active'); });
                    this.classList.add('active');
                    var f = this.getAttribute('data-filter');
                    var filtered = f === 'all' ? vessels : vessels.filter(function(v) { return v.type === f; });
                    renderList(filtered);
                });
            });
        }

        // Start loading
        loadLeaflet();

        // Simulate movement
        setInterval(function() {
            if (!map) return;
            vessels.forEach(function(v) {
                if (v.active && v.status.toLowerCase().indexOf('sailing') > -1) {
                    v.lat += (Math.random() - 0.5) * 0.008;
                    v.lng += (Math.random() - 0.5) * 0.008;
                    if (markers[v.id]) markers[v.id].setLatLng([v.lat, v.lng]);
                }
            });
        }, 5000);
    </script>
</body>
</html>
